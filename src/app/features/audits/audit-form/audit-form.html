<div class="form-container">
    <div class="header">
        <div class="title-section">
            <h1>{{ isEditMode() ? 'Editar Auditoria' : 'Nova Auditoria' }}</h1>
            <p class="subtitle">{{ isEditMode() ? 'Atualize as informa√ß√µes' : 'Planejamento e defini√ß√£o de escopo' }}
            </p>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="tabs">
        <button class="tab-btn" [class.active]="activeTab() === 'geral'" (click)="setActiveTab('geral')">1. Vis√£o Geral
            & Controles</button>
        <button class="tab-btn" [class.active]="activeTab() === 'riscos'" (click)="setActiveTab('riscos')">2. Avalia√ß√£o
            de Riscos</button>
        <button class="tab-btn" [class.active]="activeTab() === 'planejamento'"
            (click)="setActiveTab('planejamento')">3. Matriz de Planejamento (PQAE)</button>
    </div>

    <!-- Geral Tab (Inside main card) -->
    <div class="card form-card main-card" *ngIf="activeTab() === 'geral'">
        <form [formGroup]="form" (ngSubmit)="onSubmit()">
            <div class="form-grid">
                <div class="form-group">
                    <label for="code">C√≥digo da Auditoria</label>
                    <input id="code" type="text" formControlName="code" placeholder="Ex: AUD-2024-003">
                </div>

                <div class="form-group">
                    <label for="department">Departamento / √ìrg√£o</label>
                    <input id="department" type="text" formControlName="department"
                        placeholder="Ex: Secretaria de Sa√∫de">
                </div>

                <div class="form-group full-width">
                    <label for="title">T√≠tulo da Auditoria</label>
                    <input id="title" type="text" formControlName="title" placeholder="Descreva o objetivo principal">
                </div>

                <div class="form-group">
                    <label for="startDate">Data de In√≠cio</label>
                    <input id="startDate" type="date" formControlName="startDate">
                </div>

                <div class="form-group">
                    <label for="riskLevel">N√≠vel de Risco Inicial</label>
                    <select id="riskLevel" formControlName="riskLevel">
                        <option value="baixo">Baixo</option>
                        <option value="medio">M√©dio</option>
                        <option value="alto">Alto</option>
                    </select>
                </div>

                <div class="form-group full-width">
                    <label for="teamId">Equipe de Auditoria Respons√°vel</label>
                    <select id="teamId" formControlName="teamId">
                        <option value="">-- Selecione uma Equipe --</option>
                        <option *ngFor="let team of teamService.teams()" [value]="team.id">
                            {{ team.title }} ({{ team.members.length }} membros)
                        </option>
                    </select>
                </div>
                <div class="form-group full-width">
                    <label for="keyControls">Entendimento da Unidade / Controles-Chave (Etapa 1)</label>
                    <textarea id="keyControls" formControlName="keyControls" rows="4"
                        placeholder="Descreva os controles-chave esperados e o entendimento da √°rea..."></textarea>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" routerLink="/audits">Cancelar</button>
                <button type="button" class="btn btn-primary" (click)="setActiveTab('riscos')">Pr√≥ximo: Avalia√ß√£o de
                    Riscos</button>
            </div>
        </form>
    </div>

    <!-- Planning Matrix Tab (Detailed 9-field view) -->
    <div *ngIf="activeTab() === 'planejamento'" class="tab-content-wrapper">
        <div class="section-desc">
            <h3>Matriz de Planejamento Detalhada</h3>
            <p>Preencha os campos para definir o escopo da auditoria. Passe o mouse sobre o √≠cone (?) para ajuda.</p>
        </div>

        <form [formGroup]="form" (ngSubmit)="onSubmit()">
            <div formArrayName="planningMatrix">
                <div class="finding-style-card" *ngFor="let row of planningMatrix.controls; let i=index"
                    [formGroupName]="i">
                    <div class="card-header">
                        <h4>Quest√£o #{{i + 1}}</h4>
                        <button type="button" class="btn-icon danger" (click)="removeMatrixRow(i)"
                            *ngIf="planningMatrix.length > 1">üóëÔ∏è</button>
                    </div>

                    <!-- Row 1: Quest√£o (Principal) -->
                    <div class="form-group full">
                        <label>
                            Quest√µes de Auditoria
                            <span class="help-icon" [title]="helpTexts['question']">?</span>
                        </label>
                        <textarea formControlName="question" placeholder="Ex: A aquisi√ß√£o seguiu os ditames da lei?"
                            rows="3"></textarea>
                    </div>

                    <!-- Row 2: Informa√ß√µes e Fontes -->
                    <div class="form-grid two-col">
                        <div class="form-group">
                            <label>
                                Informa√ß√µes Requeridas
                                <span class="help-icon" [title]="helpTexts['informationRequired']">?</span>
                            </label>
                            <textarea formControlName="informationRequired" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>
                                Fontes de Informa√ß√£o
                                <span class="help-icon" [title]="helpTexts['sourceOfInformation']">?</span>
                            </label>
                            <textarea formControlName="sourceOfInformation" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Row 3: Procedimentos e Detalhamento -->
                    <div class="form-grid two-col">
                        <div class="form-group">
                            <label>
                                Procedimentos
                                <span class="help-icon" [title]="helpTexts['procedure']">?</span>
                            </label>
                            <textarea formControlName="procedure" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>
                                Detalhamento do Procedimento
                                <span class="help-icon" [title]="helpTexts['procedureDetail']">?</span>
                            </label>
                            <textarea formControlName="procedureDetail" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Row 4: Objetos, Respons√°vel, Per√≠odo -->
                    <div class="form-grid three-col">
                        <div class="form-group">
                            <label>
                                Objetos
                                <span class="help-icon" [title]="helpTexts['objects']">?</span>
                            </label>
                            <textarea formControlName="objects" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label>
                                Membro Respons√°vel
                                <span class="help-icon" [title]="helpTexts['responsibleMember']">?</span>
                            </label>
                            <textarea formControlName="responsibleMember" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label>
                                Per√≠odo
                                <span class="help-icon" [title]="helpTexts['period']">?</span>
                            </label>
                            <textarea formControlName="period" rows="2"></textarea>
                        </div>
                    </div>

                    <!-- Row 5: Poss√≠veis Achados -->
                    <div class="form-group full">
                        <label>
                            Poss√≠veis Achados
                            <span class="help-icon" [title]="helpTexts['possibleFindings']">?</span>
                        </label>
                        <textarea formControlName="possibleFindings" rows="2"></textarea>
                    </div>
                </div>
            </div>

            <div class="add-row-action">
                <button type="button" class="btn btn-secondary small" (click)="addMatrixRow()">+ Adicionar
                    Quest√£o</button>
            </div>

            <div class="form-actions-fixed">
                <button type="button" class="btn btn-secondary" (click)="setActiveTab('riscos')">Voltar: Riscos</button>
                <button type="submit" class="btn btn-success" [disabled]="form.invalid">
                    {{ isEditMode() ? 'Salvar Edi√ß√£o' : 'Concluir Planejamento' }}
                </button>
            </div>
        </form>
    </div>

    <!-- Risks Matrix Tab (Distinct items) -->
    <div *ngIf="activeTab() === 'riscos'" class="tab-content-wrapper">
        <div class="section-desc">
            <h3>Matriz de Riscos</h3>
            <p>Identifique os eventos de risco, avalie a probabilidade e o impacto, e defina respostas.</p>
        </div>

        <form [formGroup]="form" (ngSubmit)="onSubmit()">
            <div formArrayName="risks">
                <div class="finding-style-card risk-card" *ngFor="let risk of risks.controls; let i=index"
                    [formGroupName]="i">
                    <div class="card-header">
                        <h4>Risco #{{i + 1}}</h4>
                        <button type="button" class="btn-icon danger" (click)="removeRiskRow(i)">üóëÔ∏è</button>
                    </div>

                    <!-- 1. Identifica√ß√£o -->
                    <div class="form-grid four-col">
                        <div class="form-group">
                            <label>Ref. <span class="help-icon" [title]="helpTexts['reference']">?</span></label>
                            <input formControlName="reference" type="text" placeholder="R1">
                        </div>
                        <div class="form-group" style="grid-column: span 3;">
                            <label>Processo <span class="help-icon" [title]="helpTexts['process']">?</span></label>
                            <input formControlName="process" type="text">
                        </div>
                    </div>

                    <div class="form-group full">
                        <label>Evento de Risco (O que pode acontecer?) <span class="help-icon"
                                [title]="helpTexts['event']">?</span></label>
                        <textarea formControlName="event" rows="2"></textarea>
                    </div>

                    <!-- 2. Risco Inerente & Controles -->
                    <div class="risk-analysis-grid">
                        <!-- Inerente -->
                        <div class="analysis-box inherent">
                            <h5>Risco Inerente</h5>
                            <div class="form-group">
                                <label>Probabilidade</label>
                                <select formControlName="probability">
                                    <option value="baixa">Baixa</option>
                                    <option value="media">M√©dia</option>
                                    <option value="alta">Alta</option>
                                    <option value="muito_alta">Muito Alta</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>N√≠vel Inerente</label>
                                <select formControlName="inherentRiskLevel" class="risk-level-select">
                                    <option value="baixo">Baixo</option>
                                    <option value="medio">M√©dio</option>
                                    <option value="alto">Alto</option>
                                    <option value="extremo">Extremo</option>
                                </select>
                            </div>
                        </div>

                        <!-- Controles -->
                        <div class="controls-box">
                            <div class="form-group full-height">
                                <label>Controles Identificados <span class="help-icon"
                                        [title]="helpTexts['controls']">?</span></label>
                                <textarea formControlName="controlsIdentified"
                                    placeholder="Descreva os controles existentes..."></textarea>
                            </div>
                        </div>

                        <!-- Avalia√ß√£o Resposta/Residual -->
                        <div class="analysis-box residual">
                            <h5>Avalia√ß√£o Resposta</h5>
                            <div class="form-group">
                                <label>Efic√°cia <span class="help-icon"
                                        [title]="helpTexts['effectiveness']">?</span></label>
                                <select formControlName="controlEffectiveness">
                                    <option value="fraco">Fraco</option>
                                    <option value="satisfatorio">Satisfat√≥rio</option>
                                    <option value="forte">Forte</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Risco Residual <span class="help-icon"
                                        [title]="helpTexts['residualRisk']">?</span></label>
                                <select formControlName="residualRiskLevel" class="risk-level-select">
                                    <option value="baixo">Baixo</option>
                                    <option value="medio">M√©dio</option>
                                    <option value="alto">Alto</option>
                                    <option value="critico">Cr√≠tico</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <hr class="separator">

                    <!-- 3. Decis√£o de Escopo & O ELO -->
                    <div class="scope-decision-grid">
                        <div class="form-group">
                            <label>Relev√¢ncia/Materialidade</label>
                            <textarea formControlName="relevance" rows="3"
                                placeholder="Impacto financeiro/social..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Viabilidade</label>
                            <select formControlName="viability">
                                <option value="normal">Normal</option>
                                <option value="dificil">Dif√≠cil</option>
                                <option value="inviavel">Invi√°vel</option>
                            </select>
                            <label style="margin-top: 1rem;">Incluir no Escopo?</label>
                            <select formControlName="includeInMatrix" style="font-weight: bold;">
                                <option value="Sim">Sim</option>
                                <option value="N√£o">N√£o</option>
                            </select>
                        </div>

                        <!-- THE LINK -->
                        <div class="form-group audit-question-box">
                            <label style="color: #0f172a; font-weight: 700;">Quest√£o de Auditoria (O Link com
                                Planejamento)</label>
                            <textarea formControlName="auditQuestion" rows="3"
                                placeholder="Formule a quest√£o que avaliar√° este risco..."></textarea>
                            <small class="hint">Esta quest√£o ser√° a base da Matriz de Planejamento.</small>
                        </div>
                    </div>

                </div>
            </div>

            <div class="add-row-action">
                <button type="button" class="btn btn-secondary small" (click)="addRiskRow()">+ Adicionar Risco</button>
            </div>

            <div class="form-actions-fixed">
                <button type="button" class="btn btn-secondary" (click)="setActiveTab('geral')">Voltar: Geral</button>
                <button type="button" class="btn btn-primary" (click)="setActiveTab('planejamento')">Pr√≥ximo: Matriz
                    PQAE</button>
            </div>
        </form>
    </div>
</div>